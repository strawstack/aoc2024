// day/6/input.txt
var input_default = ".......#.........#..............#........................#......#....#............................#..#...............#............\n...................#.............................................#...................................#............................\n...............#.................................##.........#..........#.....##...#...#.....#....#..................#.............\n#.............................................#..#.............#..........#.##.............................................#......\n#.........................................................#.....#........................................##.......................\n...........#.......#.#...........#....#.#...#......................................#...........................#...##............#\n........................................................#..#.....................................#..#................#....#...#...\n#.#.....#.........................#...........#.......................................#.......#.....................##............\n.......#..........##.....#........#..................................................#.........................................#.#\n#.#..............#.#.............................#............#....#...............#.........................#............#..#.#.#\n..........................................................#....................................................#..................\n.......................#....#...........#.....................#....#...#.......#..............#.......................#...........\n..............................#..............#.......#....................................#.....................#...#...#.........\n........#.................#...#....##..............#...........................#............................#.................#...\n..................#........................................#......#......................................................#........\n.............#.................#...#..............................................................................#...#...........\n.....................................#..........................................................#.#.#......#.........#............\n..........#...................................................................#.........##.......#..#.............................\n...#.#....................................#..#...........#.......................................................##...............\n........................................................................................................#.........................\n.........#...........#......#..............#........#....................#...#......#.............................................\n........#....#...............#....................#..........#.....................................#......#......#........#.#.....\n........................#..........................#.......#........................#................#......#.....................\n......................................#.........................................#............................#....................\n...................................#.#...#...........#.........................................#.....................#............\n.................#....#.....................................................................#..................#.........#........\n...........#...........................................................#.............................#...............#..#.........\n..#.....................#.........................................................................................................\n....................#....#.#...........................#...........................................#..............#...............\n...#...................................................#.............................................#.........#..........#.......\n.............................###.....#..#..#......................................................................................\n##................#.#.......#..............#.....#...............#..#............#................................................\n......#...............................................#.#..#............................#............#.................#..........\n........................................#.#...................................................#.....#.............................\n#.......#.#.......................#.....#....................................#...................#................................\n...##................................................................................................#.....................#......\n............#.............#..................#.................#..................................................................\n...#..............#..............................................................................#..........#......#..............\n...#..#...#................................................#.....................#......#......................#.......#..........\n.................#..#........#...............#.#................#......##.................#.................................#.....\n#.....#.......#...........................................#..........#..............................#...#.#..#......#.....#.......\n....................................#.........#........#..................#.............................................#.........\n#...............................#........................#.................................................#.....#................\n..#..................................#.......#.....................#..............................................................\n........#...#.....................................#......#..............#..#..#..........................#.#....#.................\n.............#..........#....#................#.......#..........................................#.....#..........................\n.............................................#................................#.........................#...#.....................\n.........#........#...................................................................#.......#....#..............................\n....................................#.......................#..............#...............................#......................\n....#....................#................................#....#...........#.............#........................................\n....#...........#...................#.#..................................................#.....................#..................\n..........#....................#............#.##...#.......#....#...............#.....#...#.........................#.............\n.......#....................................................................................................#.................#...\n...............................................................................#......#.................#...#.....................\n..................#........#..........#..........................................................................#................\n..........................................................................................#.......................................\n.#..#...........#.................................##...........................#.....#...................#..#.....................\n........................#..#..........................................................#............#..................#..........#\n...........#...................................................##...........................#...............................#.....\n........#......................................................................................................#..................\n........#..#............................#..#...........#..............................#......................#.##...........#....#\n........#...#.#..............#...#.....................#....................#.#..............................#....................\n.......................................................#....................................................#..#..................\n...........................................#......................#................#........................#....................#\n.............#...............#................................................................................#...................\n..#...#............#.............#.....#........................#............#....................#...............................\n.....#...................................................................................................................#........\n....................#..#...........#....#.............................................................................#.......#...\n..............#......#.........................#...........#...#...........................................#...#..................\n..............................#.....#.........................................................#......#.#......#...................\n............................................................#...................#.#............................#..................\n.............###.#........................................#........................................................#..............\n......#................................#...............##.........................................................................\n.........#.....#.#.....................#.......................................#...............#..........#....#....#.............\n..............................................#....................................#...........................................#..\n............#.#..........#........#..#.....#.............#..........#............#......#...................##..........#.........\n............#....#...................................#.............................#.........................#....................\n.#..................................#....#.........................................................................#..............\n.........................#...#...#.................#..................#.............#.#...#...............#.......................\n.........#...............................#...........#.............................#...........................#..........#.......\n......#..........................#.............#..........#.......................................................................\n.......#...............#.........#.............#...............................#..................................................\n..#......#....................##...........................................#........................................#.............\n..........................#.....#.......................#...........................................................#.#...........\n..#....................#.............#................................................................#.#.........................\n.........#....................#.....#....#...............#.......................#........#.......................................\n..............#...................................................................#................#...#..........................\n....................#.....#.......#..#......................................#...........#..................................##....#\n.......#.......................................................................#..................................................\n......#.............##..........................#..#......................^.......................................................\n..............................#..........#...................#.................................#.....................#............\n.......................##..........................#.......#..............................#...................................#.#.\n................#....................................................................#...............................#.........#..\n..........................................#......#.....................................#................#........#................\n#......................................#.......................................................#..#...........#...................\n.......#.............#..................#..#...#............#.......#.....#.....#.#...............................................\n.............................#........#.............#.....#.......#...................................#.#..................#......\n.................#......................................................................................#........#..#.............\n........................................................................#..............#.....#..............................#.....\n....#....#..........................................#......##...#....................#...................#..........#.............\n.................##.......................##.#.........#................................................#.........................\n.#..............................................#.........................#.#.#..........#.....................................##.\n............................................................#..........#....#...................................................#.\n....#...........#.............................#.....................#.........#..................#...........................#....\n......#.#.......#..#......#........#..#...................#....#..................................................................\n............#........................................................................................................#............\n.....................................................#..........................................#................#................\n...#.......#..#..............#.............................#....................................#.................................\n.................##.........#........................#....................................#...............#.#.#...................\n................#......#......................#..#..........................................#.....................................\n......#..................................................##.#.#........#...........................#.......................#......\n........................#............#......#.........#.............#.............................................#.....#.##......\n......................#........................................#.......#.........#.................#..#...........#...............\n..#.......#.........##..#.#................................................................................#.........#............\n........................................................................................#............#...........#................\n................#...#....................#..##..#...............#.............................................................#...\n...#........#..........................#.....#..........................#....................................#.........#.......##.\n.................#...........................#.........#......#............................#.....................#................\n...................#..........#....#.......#...................#.............................#..........#.........................\n.......#..............#.................................#.........#....................................#.................#....##.#\n..................................#.......................#....#..#.........................#....................#................\n.....#.........#............#...#.........#........#...................#...#......................#.....#............#............\n#.#....#...#........#................................##..........................#.............................##...#....#........\n.............##..........##...#......#.......#.#................#.#.......................#.............#.........................\n.............#....................................#....................................#..........................................\n..................................#..............................#.......................................#................#.......\n...................#...............#..............................................................................................\n....#........#.................................#........#.....................................#.......#................#........#.\n.................#......#.......................................................##.....#..................#.......................\n...............#.......................#.#........#...........................................#........#..........................\n";

// helper.js
function prototypes() {
  const arr = {
    dropLast: function() {
      this.pop();
      return this;
    },
    unzip: function() {
      const left = [];
      const right = [];
      this.forEach((v) => {
        left.push(v[0]);
        right.push(v[1]);
      });
      return [left, right];
    },
    zip: function() {
      const res = [];
      const left = this[0];
      const right = this[1];
      for (let i = 0;i < Math.max(left.length, right.length); i++) {
        const l = i < left.length ? left[i] : null;
        const r = i < right.length ? right[i] : null;
        res.push([l, r]);
      }
      return res;
    }
  };
  const obj = {
    add: function(vec) {
      return {
        x: this.x + vec.x,
        y: this.y + vec.y
      };
    },
    eq: function(vec) {
      return this.x === vec.x && this.y === vec.y;
    },
    flip: function() {
      return this.mul(-1);
    },
    mul: function(s) {
      return {
        x: s * this.x,
        y: s * this.y
      };
    },
    keys: function() {
      return Object.keys(this).filter((k) => this.hasOwnProperty(k));
    }
  };
  for (let k in arr) {
    Object.defineProperty(Array.prototype, k, {
      value: arr[k],
      enumerable: false
    });
  }
  for (let k in obj) {
    Object.defineProperty(Object.prototype, k, {
      value: obj[k],
      enumerable: false
    });
  }
}
function not(value) {
  return !value;
}

// day/6/p2.js
var toVec = {
  U: { x: 0, y: -1 },
  R: { x: 1, y: 0 },
  D: { x: 0, y: 1 },
  L: { x: -1, y: 0 }
};
var rot = {
  U: "R",
  R: "D",
  D: "L",
  L: "U"
};
function inBoundsPassthrough(grid, pos) {
  return inBounds(grid, pos) ? pos : null;
}
function inBounds(grid, { x, y }) {
  return y >= 0 && y < grid.length && x >= 0 && x < grid[y].length;
}
function hash(pos) {
  return JSON.stringify(pos);
}
function trackHash(vid, dir) {
  return `${vid}${dir}`;
}
function main(graph, vid, dir) {
  const track = {};
  let nvid = vid;
  while (true) {
    const tr = trackHash(nvid, dir);
    if (tr === `{"x":74,"y":41}R`) {
      console.log("hello");
      debugger;
    }
    if (tr in track)
      return true;
    track[tr] = true;
    nvid = graph[nvid][dir];
    if (nvid === null)
      return false;
    dir = rot[dir];
  }
}
function placeBlock(graph, grid, { x, y }, additional) {
  const undos = [];
  const h = hash({ x, y });
  graph[h] = {
    U: null,
    R: null,
    D: null,
    L: null
  };
  undos.push(() => {
    delete graph[h];
  });
  const adj = {
    U: inBoundsPassthrough(grid, { x, y }.add(toVec["U"])),
    R: inBoundsPassthrough(grid, { x, y }.add(toVec["R"])),
    D: inBoundsPassthrough(grid, { x, y }.add(toVec["D"])),
    L: inBoundsPassthrough(grid, { x, y }.add(toVec["L"]))
  };
  for (let key in adj) {
    let pos = adj[key];
    if (pos) {
      const dir = rot[rot[rot[key]]];
      while (true) {
        let n = pos.add(toVec[dir]);
        if (not(inBounds(grid, n)))
          break;
        if (grid[n.y][n.x] === "#") {
          graph[h][rot[rot[key]]] = hash(n);
          break;
        } else {
          pos = n;
        }
      }
    }
  }
  if (additional) {
    for (let key in adj) {
      let pos = { x, y };
      const dir = key;
      while (true) {
        let n = pos.add(toVec[dir]);
        if (not(inBounds(grid, n)))
          break;
        if (grid[n.y][n.x] === "#")
          break;
        const side = n.add(toVec[rot[dir]]);
        if (not(inBounds(grid, side)))
          break;
        if (grid[side.y][side.x] === "#") {
          const before = graph[hash(side)][rot[dir]];
          graph[hash(side)][rot[dir]] = h;
          const hs = hash(side);
          const rd = rot[dir];
          undos.push(() => {
            graph[hs][rd] = before;
          });
        } else {
          pos = n;
        }
      }
    }
  }
  return () => {
    for (let u of undos) {
      u();
    }
  };
}
function grid2graph(grid) {
  const graph = {};
  grid.forEach((_, y) => {
    grid[y].forEach((c, x) => {
      if (c === "#") {
        placeBlock(graph, grid, { x, y });
      }
    });
  });
  return graph;
}
function getStart(grid, { x, y }, pos) {
  let dir = "U";
  while (true) {
    let n = pos.add(toVec[dir]);
    if (not(inBounds(grid, n))) {
      throw new Error("Should not get here. Should always hit a block.");
    }
    if (n.eq({ x, y }))
      return { x, y };
    if (grid[n.y][n.x] === "#") {
      return n;
    } else {
      pos = n;
    }
  }
}
function sol(data) {
  const grid = data.trim().split("\n").map((line) => line.split(""));
  const graph = grid2graph(grid);
  const pos = (() => {
    let pos2 = null;
    grid.forEach((_, y) => {
      grid[y].forEach((c, x) => {
        if (c === "^") {
          pos2 = { x, y };
        }
      });
    });
    return pos2;
  })();
  let graph_total = 0;
  for (let y = 0;y < grid.length; y++) {
    for (let x = 0;x < grid[y].length; x++) {
      if (grid[y][x] === "#")
        continue;
      if (grid[y][x] === "^")
        continue;
      const undo = placeBlock(graph, grid, { x, y }, true);
      const sv = getStart(grid, { x, y }, pos);
      if (main(graph, hash(sv), "U")) {
        graph_total += 1;
      }
      undo();
    }
  }
  return graph_total.toString();
}
prototypes();
console.log(sol(input_default));
